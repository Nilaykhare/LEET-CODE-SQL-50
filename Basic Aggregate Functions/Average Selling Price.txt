select product_id , COALESCE (round(SUM(TotalsalePrice)*1.0/ Sum(units),2),0) as average_price from 
(select Prices.product_id, Prices.start_date , Prices.end_date , Prices.price , UnitsSold.purchase_date, UnitsSold.units, Prices.price*UnitsSold.units as TotalsalePrice from Prices left join UnitsSold on Prices.product_id  = UnitsSold.product_id and UnitsSold.purchase_date BETWEEN Prices.start_date and Prices.end_date ) As T
group by product_id